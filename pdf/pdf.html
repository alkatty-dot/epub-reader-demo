
<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
  <title>2025童書星創獎【PDF閱讀器】</title>
  <link rel="stylesheet" href="pdf.css">
  <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.2.228/pdf.min.js"></script> -->
  <script type="text/javascript" src="../data.js"></script>
  <script src="jquery1.8.3.js"></script>
  <script type="text/javascript" src="pdf.js"></script>
</head>

<body>

<div id="pdf-main-container">
	<div id="pdf-loader">讀取中 請稍後 ...</div>
	<div id="pdf-contents">
		<div id="pdf-meta" style="margin-right: 20px">
			<div id="pdf-buttons">
			<!-- 功能按鈕（保持原本順序與 id） -->
			<button id="prev">上一頁(a)</button>
			<button id="next">下一頁(d)</button>
			<button onclick="addScale(-0.2)">放大(+)</button>
			<button onclick="addScale(0.2)">縮小(-)</button>

			<!-- ✅ 單一頁數膠囊（只保留這一個，且不要再有三個 float 的舊結構） -->
			<div id="page-count-container">
				<span id="page_num">1</span>
			</div>

			<!-- 關閉按鈕（獨立，不要再包在 float 的 <div> 裡） -->
			<button id="close" onclick="closeSelf()">關閉</button>
			</div>
		</div>
		<canvas id="pdf-canvas" ></canvas>
		<div id="page-loader">讀取中 請稍後 ...</div>
	</div>
</div>

<script>


pdfjsLib.GlobalWorkerOptions.workerSrc = 'pdf.worker.js';

var pdfDoc = null,
    pageNum = 1,
    pageRendering = false,
    pageNumPending = null,
    scale = 1,
    canvas = document.getElementById('pdf-canvas'),
    ctx = canvas.getContext('2d');
    
    //這裡是螢幕寬度80% 
canvas.width = window.innerWidth * 0.8;
// var isScaled = false;	
/**
 * Get page info from document, resize canvas accordingly, and render page.
 * @param num Page number.
 */
function renderPage(num) {
  pageRendering = true;
  // Using promise to fetch the page
  pdfDoc.getPage(num).then(function(page) {
    var viewport = page.getViewport({scale: scale});
//     if(isScaled == false){
    	var cw = 800;
    	var w = viewport.width;
	    var vscale = canvas.width/w;
	    canvas.height = viewport.height *vscale;
	     viewport = page.getViewport({scale: vscale});
//     }else{
//     	canvas.width = viewport.width;
//     	canvas.height = viewport.height;
//     }
   
 
    

    // Render PDF page into canvas context
    var renderContext = {
      canvasContext: ctx,
      viewport: viewport
    };
    var renderTask = page.render(renderContext);

    // Wait for rendering to finish
    renderTask.promise.then(function() {
      pageRendering = false;
      if (pageNumPending !== null) {
        // New page rendering is pending
        renderPage(pageNumPending);
        pageNumPending = null;
      }
    });
  });

  // Update page counters
  document.getElementById('page_num').textContent = num;
}

/**
 * If another page rendering in progress, waits until the rendering is
 * finised. Otherwise, executes rendering immediately.
 */
function queueRenderPage(num) {
  if (pageRendering) {
    pageNumPending = num;
  } else {
    renderPage(num);
  }
}

/**
 * Displays previous page.
 */
function onPrevPage() {
  if (pageNum <= 1) {
    return;
  }
  pageNum--;
  queueRenderPage(pageNum);
}
document.getElementById('prev').addEventListener('click', onPrevPage);

/**
 * Displays next page.
 */
function onNextPage() {
  if (pageNum >= pdfDoc.numPages) {
    return;
  }
  pageNum++;
  queueRenderPage(pageNum);
}
document.getElementById('next').addEventListener('click', onNextPage);

/**
 * Asynchronously downloads PDF.
 */

 
 
 
 
 function changeScale(v){
	 scale = v;
	 queueRenderPage(pageNum);
 }
 
 
 function addScale(v){
	var temp = scale + v;
	if(temp == 0){
		temp = 0.2;
	}else if(temp >= 3){
		temp = 3;
	}
	scale = temp;
	queueRenderPage(pageNum);
	return;
 }
 
 
 
 document.addEventListener('keyup', function(e){
	 
	 if(e.keyCode == 65){
		 onPrevPage();
	 }else if(e.keyCode == 68){
		 onNextPage();
	 }else if(e.keyCode == 187){
		 addScale(-0.2);
	 }else if(e.keyCode == 189){
		 addScale(0.2);
	 }
	 
 } , false);
 
 
 function a(){
	 onPrevPage();
 }
 function d(){
	 onNextPage();
 }
 
 function big(){
	 addScale(-0.2);
 }
 
 function small(){
	 addScale(0.2);
 }
 
 function closeSelf(){
	 console.log(111);
	 console.log(window.parent);
	 window.parent.close(); 
 }

</script>


<script>
    function do_logic(){  

		 let CMAP_URL = 'https://mozilla.github.io/pdf.js/web/cmaps/'
		 
		 var pdf_url = "../"+selected_book.file;
// 		alert(pdf_url)
		 var a = pdfjsLib.getDocument({ url: pdf_url , cMapUrl: CMAP_URL , cMapPacked : true});
		 a.promise.then(function(pdfDoc_) {
			$('#pdf-loader').hide();
			$('#pdf-contents').show();
		  pdfDoc = pdfDoc_;
		  document.getElementById('pdf-total-pages').textContent = pdfDoc.numPages;
		
		  // Initial/first page rendering
		  renderPage(pageNum);
		});
    }
  </script>
  
  
  <script type="text/javascript" src="../get_data.js"></script>
</body>
</html>